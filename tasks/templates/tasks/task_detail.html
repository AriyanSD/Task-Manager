{% extends 'base.html' %}

{% block title %}Task Detail{% endblock %}

{% block content %}
<div class="row">
  <div class="col-md-8 offset-md-2">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2>Task Details</h2>
      <a href="{% url 'tasks_list' %}" class="btn btn-secondary">Back to List</a>
    </div>

    <div id="taskDetailContainer">
      <div class="text-center">
        <div class="spinner-border" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const currentUsername = "{{ user.username }}";

// Extract taskId from URL: /task/4/ â†’ "4"
const taskId = window.location.pathname.split('/').filter(Boolean).pop();

// Get CSRF token from cookie
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.startsWith(name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}
const csrftoken = getCookie('csrftoken');

// Show/hide spinner
function showLoading() {
  const spinner = document.getElementById('taskDetailContainer').querySelector('.spinner-border');
  if (spinner) spinner.style.display = 'block';
}
function hideLoading() {
  const spinner = document.getElementById('taskDetailContainer').querySelector('.spinner-border');
  if (spinner) spinner.style.display = 'none';
}

// Fetch task details
async function fetchTaskDetail() {
  showLoading();
  try {
    const response = await fetch(`/api/tasks/${taskId}/`, {
      method: 'GET',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'same-origin'
    });

    if (!response.ok) {
      if (response.status === 404) throw new Error('Task not found');
      throw new Error('Failed to fetch task');
    }

    const task = await response.json();
    displayTaskDetail(task);
  } catch (error) {
    console.error('Error:', error);
    document.getElementById('taskDetailContainer').innerHTML = 
      `<div class="alert alert-danger">${error.message}</div>`;
  } finally {
    hideLoading();
  }
}

// Display task in DOM
function displayTaskDetail(task) {
  const statusBadge = task.status === 'done' ? 'bg-success' : 
                      task.status === 'in_progress' ? 'bg-warning text-dark' : 
                      'bg-secondary';
  const statusText = task.status === 'done' ? 'Done' :
                     task.status === 'in_progress' ? 'In Progress' : 
                     'To Do';

  const isOwner = task.owner.username === currentUsername;
  const actionButtons = isOwner ? `
    <hr>
    <div class="d-flex gap-2">
      <a href="/task/${task.id}/update/" class="btn btn-warning">Edit Task</a>
      <button onclick="deleteTask()" class="btn btn-danger">Delete Task</button>
    </div>
  ` : '';

  document.getElementById('taskDetailContainer').innerHTML = `
    <div class="card">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start mb-3">
          <h3 class="card-title">${escapeHtml(task.title)}</h3>
          <span class="badge ${statusBadge}">${statusText}</span>
        </div>

        <div class="mb-3">
          <h5>Description</h5>
          <p>${escapeHtml(task.description || 'No description provided').replace(/\n/g, '<br>')}</p>
        </div>

        <hr>

        <div class="row">
          <div class="col-md-6">
            <p><strong>Owner:</strong> ${escapeHtml(task.owner.username)}</p>
          </div>
          <div class="col-md-6">
            <p><strong>Created:</strong> ${new Date(task.created_at).toLocaleString()}</p>
          </div>
        </div>

        ${task.updated_at ? `
        <div class="row">
          <div class="col-md-12">
            <p><strong>Last Updated:</strong> ${new Date(task.updated_at).toLocaleString()}</p>
          </div>
        </div>` : ''}

        ${actionButtons}
      </div>
    </div>
  `;
}

// Delete task
async function deleteTask() {
  if (!confirm('Are you sure you want to delete this task?')) return;

  showLoading();
  try {
    const response = await fetch(`/api/tasks/${taskId}/`, {
      method: 'DELETE',
      headers: { 'X-CSRFToken': csrftoken },
      credentials: 'same-origin'
    });

    if (!response.ok) throw new Error('Failed to delete task');
    window.location.href = '{% url "tasks_list" %}';
  } catch (error) {
    console.error('Error:', error);
    alert('Failed to delete task. Please try again.');
    hideLoading();
  }
}

// Escape HTML to prevent XSS
function escapeHtml(text) {
  if (!text) return '';
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// Init
document.addEventListener('DOMContentLoaded', fetchTaskDetail);
</script>
{% endblock %}
