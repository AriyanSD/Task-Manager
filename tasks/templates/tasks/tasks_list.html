{% extends 'base.html' %} {% block title %}Task List{% endblock %} 
{% block content %}
<div class="row mb-4">
  <div class="col-md-8">
    <h2>My Tasks</h2>
  </div>
  <div class="col-md-4 text-end">
    <a href="{% url 'task_create' %}" class="btn btn-primary">
      <i class="bi bi-plus-circle"></i> Create New Task
    </a>
  </div>
</div>

<!-- Search and Filter Form -->
<div class="card mb-4">
  <div class="card-body">
    <form id="filterForm" class="row g-3">
      <div class="col-md-6">
        <input
          type="text"
          id="searchInput"
          name="search"
          class="form-control"
          placeholder="Search tasks..."
        />
      </div>
      <div class="col-md-4">
        <select id="statusFilter" name="status" class="form-select">
          <option value="">All Statuses</option>
          <option value="todo">To Do</option>
          <option value="in_progress">In Progress</option>
          <option value="done">Done</option>
        </select>
      </div>
      <div class="col-md-2">
        <button type="submit" class="btn btn-secondary w-100">Filter</button>
      </div>
    </form>
  </div>
</div>

<!-- Tasks List -->
<div id="tasksContainer" class="row"></div>

<div id="noTasksMessage" class="alert alert-info" style="display: none">
  No tasks found. <a href="{% url 'task_create' %}">Create your first task!</a>
</div>

<!-- Spinner -->
<div id="loadingSpinner" class="text-center my-4" style="display: none">
  <div class="spinner-border" role="status">
    <span class="visually-hidden">Loading...</span>
  </div>
</div>
{% endblock %} {% block extra_js %}
<script>
  const currentUsername = "{{ user.username }}";
  let currentSearch = "";
  let currentStatus = "";

  function showLoading() {
    document.getElementById("loadingSpinner").style.display = "block";
  }

  function hideLoading() {
    document.getElementById("loadingSpinner").style.display = "none";
  }

  async function fetchTasks() {
    showLoading();
    try {
      let url = "api/tasks/";
      const params = new URLSearchParams();
      if (currentSearch) params.append("search", currentSearch);
      if (currentStatus) params.append("status", currentStatus);
      if (params.toString()) url += "?" + params.toString();

      const response = await fetch(url, {
        method: "GET",
        headers: { "Content-Type": "application/json" },
        credentials: "same-origin",
      });

      if (!response.ok) throw new Error("Failed to fetch tasks");

      const tasks = await response.json();
      displayTasks(tasks);
    } catch (error) {
      console.error("Error:", error);
      document.getElementById("tasksContainer").innerHTML =
        '<div class="col-12"><div class="alert alert-danger">Failed to load tasks. Please try again.</div></div>';
    } finally {
      hideLoading();
    }
  }

  function displayTasks(tasks) {
  const container = document.getElementById("tasksContainer");
  const noTasksMsg = document.getElementById("noTasksMessage");

  if (tasks.length === 0) {
    container.style.display = "none";
    noTasksMsg.style.display = "block";
    return;
  }

  noTasksMsg.style.display = "none";
  container.style.display = "flex";
  container.innerHTML = tasks
    .map((task) => {
      const statusBadge =
        task.status === "done"
          ? "bg-success"
          : task.status === "in_progress"
          ? "bg-warning text-dark"
          : "bg-secondary";

      const statusText =
        task.status === "done"
          ? "Done"
          : task.status === "in_progress"
          ? "In Progress"
          : "To Do";

      const isOwner = task.owner_username === currentUsername;
      const editDeleteButtons = isOwner
        ? `
      <a href="/tasks/${task.id}/edit/" class="btn btn-sm btn-outline-warning">Edit</a>
      <button onclick="deleteTask(${task.id})" class="btn btn-sm btn-outline-danger">Delete</button>
    `
        : "";

      return `
      <div class="col-md-6 mb-3">
        <div class="card h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <h5 class="card-title">${escapeHtml(task.title)}</h5>
              <span class="badge ${statusBadge}">${statusText}</span>
            </div>
            <p class="card-text">${escapeHtml(truncate(task.description, 100))}</p>
            <p class="text-muted small">
              <strong>Owner:</strong> ${escapeHtml(task.owner_username)}<br>
              <strong>Created:</strong> ${new Date(task.created_at).toLocaleDateString()}
            </p>
            <div class="d-flex gap-2">
              <a href="/tasks/${task.id}/" class="btn btn-sm btn-outline-primary">View</a>
              ${editDeleteButtons}
            </div>
          </div>
        </div>
      </div>
    `;
    })
    .join("");
}

  async function deleteTask(taskId) {
    if (!confirm("Are you sure you want to delete this task?")) return;

    showLoading();
    try {
      const response = await fetch(`/api/task/${taskId}/`, {
        method: "DELETE",
        headers: { "X-CSRFToken": csrftoken },
        credentials: "same-origin",
      });

      if (!response.ok) throw new Error("Failed to delete task");

      await fetchTasks();
    } catch (error) {
      console.error("Error:", error);
      alert("Failed to delete task. Please try again.");
    } finally {
      hideLoading();
    }
  }

  function escapeHtml(text) {
    if (!text) return "";
    const div = document.createElement("div");
    div.textContent = text;
    return div.innerHTML;
  }

  function truncate(text, length) {
    if (!text) return "";
    return text.length > length ? text.substring(0, length) + "..." : text;
  }

  // Event listeners
  document.getElementById("filterForm").addEventListener("submit", (e) => {
    e.preventDefault();
    currentSearch = document.getElementById("searchInput").value;
    currentStatus = document.getElementById("statusFilter").value;
    fetchTasks();
  });

  // Initial load
  document.addEventListener("DOMContentLoaded", fetchTasks);
</script>
{% endblock %}
