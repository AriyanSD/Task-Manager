{% extends 'base.html' %}
{% block title %}Task List{% endblock %}
{% block content %}

<div class="row mb-4">
  <div class="col-md-8">
    <h2>My Tasks</h2>
  </div>
  <div class="col-md-4 text-end">
    <a href="{% url 'task_create' %}" class="btn btn-primary">
      <i class="bi bi-plus-circle"></i> Create New Task
    </a>
  </div>
</div>

<!-- Search, Status & Owner Filter -->
<div class="card mb-4">
  <div class="card-body">
    <form id="filterForm" class="row g-3">
      <div class="col-md-4">
        <input
          type="text"
          id="searchInput"
          class="form-control"
          placeholder="Search tasks..."
        />
      </div>
      <div class="col-md-3">
        <select id="statusFilter" class="form-select">
          <option value="">All Statuses</option>
          <option value="todo">To Do</option>
          <option value="in_progress">In Progress</option>
          <option value="done">Done</option>
        </select>
      </div>

      <div class="col-md-3">
        <select id="ownerFilter" class="form-select">
          <option value="">All Owners</option>
          <option value="mine">Only My Tasks</option>
        </select>
      </div>

      <div class="col-md-2">
        <button type="submit" class="btn btn-secondary w-100">Filter</button>
      </div>
    </form>
  </div>
</div>

<!-- Tasks List -->
<div id="tasksContainer" class="row"></div>

<div id="noTasksMessage" class="alert alert-info" style="display: none">
  No tasks found. <a href="{% url 'task_create' %}">Create your first task!</a>
</div>

<!-- Loading Spinner -->
<div id="loadingSpinner" class="text-center my-4" style="display: none">
  <div class="spinner-border" role="status"></div>
</div>

{% endblock %}

{% block extra_js %}
<script>

  const currentUsername = "{{ user.username }}";


  const csrftoken = document.cookie
    .split("; ")
    .find(row => row.startsWith("csrftoken="))
    ?.split("=")[1];

  let currentSearch = "";
  let currentStatus = "";
  let ownerFilter = "";

  function showLoading() {
    document.getElementById("loadingSpinner").style.display = "block";
  }

  function hideLoading() {
    document.getElementById("loadingSpinner").style.display = "none";
  }


  async function fetchTasks() {
    showLoading();
    try {
      let url = "/api/tasks/";
      const params = new URLSearchParams();

      if (currentSearch) params.append("search", currentSearch);
      if (currentStatus) params.append("status", currentStatus);

      if (params.toString()) url += "?" + params.toString();

      const response = await fetch(url, {
        method: "GET",
        headers: { "Content-Type": "application/json" },
        credentials: "same-origin",
      });

      if (!response.ok) throw new Error("Failed to fetch tasks");

      let tasks = await response.json();


      if (ownerFilter === "mine") {
        tasks = tasks.filter(t => t.owner_username === currentUsername);
      }

      displayTasks(tasks);

    } catch (error) {
      console.error("Error:", error);
      document.getElementById("tasksContainer").innerHTML =
        '<div class="col-12"><div class="alert alert-danger">Failed to load tasks.</div></div>';
    } finally {
      hideLoading();
    }
  }


  function displayTasks(tasks) {
    const container = document.getElementById("tasksContainer");
    const noTasksMsg = document.getElementById("noTasksMessage");

    if (!tasks.length) {
      container.style.display = "none";
      noTasksMsg.style.display = "block";
      return;
    }

    noTasksMsg.style.display = "none";
    container.style.display = "flex";

    container.innerHTML = tasks.map(task => {
      const statusMap = {
        done: ["bg-success", "Done"],
        in_progress: ["bg-warning text-dark", "In Progress"],
        todo: ["bg-secondary", "To Do"],
      };

      const [badgeClass, statusText] = statusMap[task.status];

      const isOwner = task.owner_username === currentUsername;

      return `
      <div class="col-md-6 mb-3">
        <div class="card h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between mb-2">
              <h5 class="card-title">${escapeHtml(task.title)}</h5>
              <span class="badge ${badgeClass}">${statusText}</span>
            </div>
            <p>${escapeHtml(truncate(task.description, 100))}</p>
            <p class="text-muted small">
              <strong>Owner:</strong> ${escapeHtml(task.owner_username)}<br>
              <strong>Created:</strong> ${new Date(task.created_at).toLocaleDateString()}
            </p>
            <div class="d-flex gap-2">
              <a href="/tasks/${task.id}/" class="btn btn-sm btn-outline-primary">View</a>
              ${isOwner ? `
                <a href="/tasks/${task.id}/edit/" class="btn btn-sm btn-outline-warning">Edit</a>
                <button onclick="deleteTask(${task.id})" class="btn btn-sm btn-outline-danger">Delete</button>
              ` : ""}
            </div>
          </div>
        </div>
      </div>`;
    }).join("");
  }

  async function deleteTask(taskId) {
    if (!confirm("Delete this task?")) return;

    try {
      const response = await fetch(`/api/tasks/${taskId}/`, {
        method: "DELETE",
        headers: { "X-CSRFToken": csrftoken },
        credentials: "same-origin",
      });

      if (!response.ok) throw new Error("Delete failed");
      fetchTasks();
    } catch (err) {
      console.error(err);
      alert("Failed to delete task.");
    }
  }


  function escapeHtml(text) {
    if (!text) return "";
    const div = document.createElement("div");
    div.textContent = text;
    return div.innerHTML;
  }

  function truncate(text, length) {
    return text && text.length > length ? text.substring(0, length) + "..." : text;
  }


  document.getElementById("filterForm").addEventListener("submit", e => {
    e.preventDefault();
    currentSearch = document.getElementById("searchInput").value;
    currentStatus = document.getElementById("statusFilter").value;
    ownerFilter = document.getElementById("ownerFilter").value;
    fetchTasks();
  });

  document.addEventListener("DOMContentLoaded", fetchTasks);
</script>
{% endblock %}
